<!DOCTYPE html>
<html>
<head>
	<title>Client</title>
	<script type="text/javascript">
		
		(function(){
			"use strict";
			var video;
			var scale = 0.25;
			var mediaOptions = { audio: false, video: true };

			if(!navigator.getUserMedia){navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia;}

			if(!navigator.getUserMedia){return alert('getUserMedia not supported in this browser.');}

			navigator.getUserMedia(mediaOptions, success, function(e){console.log(e);});

			function success(stream)
			{
				video = document.querySelector("#player");
				video.src = window.URL.createObjectURL(stream);              
			}

		})();

		function react()
		{
			var video = document.querySelector("#player");
	        var canvas = document.createElement("canvas");
	        var scale = 1.0;
	        canvas.width = video.videoWidth * scale;
	        canvas.height = video.videoHeight * scale;
	        canvas.getContext('2d')
	              .drawImage(video, 0, 0, canvas.width, canvas.height);
	 
	        var img = document.querySelector("#imageCaptured");
	        	img.src = canvas.toDataURL();
	
        }

		function base64ToBlob(base64, mime) 
		{
		    mime = mime || '';
		    var sliceSize = 1024;
		    var byteChars = window.atob(base64);
		    var byteArrays = [];

		    for (var offset = 0, len = byteChars.length; offset < len; offset += sliceSize) {
		        var slice = byteChars.slice(offset, offset + sliceSize);

		        var byteNumbers = new Array(slice.length);
		        for (var i = 0; i < slice.length; i++) {
		            byteNumbers[i] = slice.charCodeAt(i);
		        }

		        var byteArray = new Uint8Array(byteNumbers);

		        byteArrays.push(byteArray);
		    }

		    return new Blob(byteArrays, {type: mime});
		}

		function sendImage()
		{
			var url = "http://127.0.0.1:5000/";
	        var img = document.querySelector("#imageCaptured");
			var image = img.src;
			var base64ImageContent = image.replace(/^data:image\/(png|jpg);base64,/, "");
			console.log(String(base64ImageContent));
			var blob = base64ToBlob(base64ImageContent, 'image/png');                
			//alert(blob)
			var formData = new FormData();
			formData.append('picture', String(base64ImageContent));

			$.ajax({
			    url: url, 
			    type: "POST", 
			    cache: false,
			    contentType: false,
			    processData: false,
			    data: formData })
			        .done(function(response){
				    	json_string = JSON.stringify(response);
	  			    	alert("RESPONSE:\n" + json_string);
			        });
		}


	</script>

	<style type="text/css">
		body{
			margin: 0px;
			padding: 0px;
		}

		#player{
			width: 20%;
			height: 20%;
		}

		#imageCaptured{
			width: 20%;
			height: 20%;
		}
	</style>

	 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
</head>
<body>

	<video id="player" autoplay="true"></video>

	<br>
	<button id="capture" onclick="react()">CAPTURE</button>
	<img id="imageCaptured">

	<br>
	<button onclick="sendImage()">SEND IMAGE</button>
</body>
</html>